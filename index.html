<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>PSL Facial Rater ⚡</title>
  <style>
    body { background:black; color:white; font-family:Arial; text-align:center; padding:20px; }
    .container { max-width:500px; margin:auto; background:#111; padding:20px; border-radius:10px; }
    #loading { margin-top:10px; }
    .progress-bar { width:100%; background:#333; border-radius:5px; height:15px; margin-top:10px; }
    .progress-fill { height:15px; background:limegreen; width:0%; border-radius:5px; }
    img { max-width:100%; border-radius:10px; margin-top:10px; }
    .hidden { display:none; }
  </style>
</head>
<body>
<div class="container">
  <h1>PSL Facial Rater ⚡</h1>
  <input type="file" id="imageUpload" accept="image/*">
  <br><button onclick="analyzeFace()">Rate Me</button>

  <div id="loading" class="hidden">
    <p id="loadingText">Loading models...</p>
    <div class="progress-bar"><div id="progressFill" class="progress-fill"></div></div>
  </div>

  <div id="resultCard" class="hidden">
    <h2 id="label"></h2>
    <p>PSL Score: <span id="pslScore"></span></p>
    <p>Beauty Score: <span id="beautyScore"></span></p>
    <img id="uploadedImg" src="">
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script>
function updateProgress(percent) {
  document.getElementById("progressFill").style.width = percent + "%";
}

async function loadModels() {
  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("loadingText").innerText = "Loading face detection models (0%)...";
  let steps = 3; // number of model files
  let loaded = 0;

  async function loadWithProgress(promise) {
    await promise;
    loaded++;
    let percent = Math.round((loaded / steps) * 100);
    updateProgress(percent);
    document.getElementById("loadingText").innerText = `Loading face detection models (${percent}%)...`;
  }

  await loadWithProgress(faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models'));
  await loadWithProgress(faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models'));
  await loadWithProgress(faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/face-api.js/models'));

  document.getElementById("loading").classList.add("hidden");
}

function convertBeautyToPSL(score) {
  if (score < 40) return { psl: 2, label: "Subhuman" };
  if (score < 50) return { psl: 3.5, label: "MTN" };
  if (score < 60) return { psl: 5, label: "HTN" };
  if (score < 70) return { psl: 5.5, label: "Chadlite" };
  return { psl: 6.5, label: "Giga Chad" };
}

async function analyzeFace() {
  const file = document.getElementById("imageUpload").files[0];
  if (!file) return alert("Upload a photo first!");

  document.getElementById("loading").classList.remove("hidden");
  document.getElementById("loadingText").innerText = "Analyzing face...";
  updateProgress(50);

  try {
    const img = await faceapi.bufferToImage(file);
    const detection = await faceapi.detectSingleFace(img, new faceapi.TinyFaceDetectorOptions()).withFaceLandmarks();

    if (!detection) {
      throw new Error("No face detected in the image.");
    }

    // FAKE beauty score until we make real symmetry calc
    const beautyScore = Math.random() * 100;

    const pslData = convertBeautyToPSL(beautyScore);

    document.getElementById("label").innerText = pslData.label;
    document.getElementById("pslScore").innerText = pslData.psl;
    document.getElementById("beautyScore").innerText = beautyScore.toFixed(1);
    document.getElementById("uploadedImg").src = URL.createObjectURL(file);

    document.getElementById("resultCard").classList.remove("hidden");
  } catch (err) {
    alert("Error analyzing face:\n" + err.message);
    console.error(err);
  } finally {
    document.getElementById("loading").classList.add("hidden");
    updateProgress(0);
  }
}

loadModels();
</script>
</body>
</html>
